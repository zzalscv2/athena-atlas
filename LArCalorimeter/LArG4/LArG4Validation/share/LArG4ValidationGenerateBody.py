# Copyright (C) 2002-2022 CERN for the benefit of the ATLAS collaboration

from AthenaCommon.DetFlags import DetFlags
# - Select detectors
DetFlags.ID_setOn()
DetFlags.Calo_setOn()
DetFlags.Muon_setOn()
DetFlags.Truth_setOn()


# get a handle to the default top-level algorithm sequence
from AthenaCommon.AlgSequence import AlgSequence
from AthenaCommon.AppMgr import ServiceMgr
topSequence = AlgSequence()

## Output threshold (DEBUG, INFO, WARNING, ERROR, FATAL)
ServiceMgr.MessageSvc.OutputLevel = options['outLVL']

from AthenaCommon.GlobalFlags import globalflags
if len(options['condition']) > 0 :
    globalflags.ConditionsTag = options['condition']
else :
    printfunc ("No condition tag specified.\nThere is no use in validating FS with some arbitrary condition tag.\n Please, specify one.")
    import sys
    sys.exit(1)


from AthenaCommon.AthenaCommonFlags import athenaCommonFlags

from EvgenJobTransforms.EvgenConfig import evgenConfig

athenaCommonFlags.PoolHitsOutput=options['output'] + '.HITS.pool.root'

athenaCommonFlags.EvtMax=options['nevents']


#--- Simulation flags -----------------------------------------
from G4AtlasApps.SimFlags import simFlags
simFlags.load_atlas_flags()
simFlags.CalibrationRun.set_Off()
simFlags.SimBarcodeOffset.set_On()

# Random seeds get random values
simFlags.RandomSeedOffset = options['firstEvent']

if len(options['geometry']) > 0 :
    simFlags.SimLayout = options['geometry']
else :
    simFlags.SimLayout.set_On()

## Global flags needed by externals
from AthenaCommon.GlobalFlags import globalflags
globalflags.DataSource = 'geant4'
globalflags.DetGeo = 'atlas'
globalflags.DetDescrVersion = simFlags.SimLayout.get_Value()

if not options ['simulate']:
    ## Translate conditions tag into IOVDbSvc global tag: must be done before job propertie are locked!!!
    from AthenaCommon.AppMgr import ServiceMgr
    from IOVDbSvc.IOVDbSvcConf import IOVDbSvc
    ServiceMgr += IOVDbSvc()
    if not hasattr(ServiceMgr.IOVDbSvc, 'GlobalTag') or not ServiceMgr.IOVDbSvc.GlobalTag:
        ServiceMgr.IOVDbSvc.GlobalTag = globalflags.ConditionsTag.get_Value()


if len(options['physlist']) > 0 :
    simFlags.PhysicsList = options['physlist']

if options['input'] is not None:
    athenaCommonFlags.PoolEvgenInput=[options['input']]
else:
    ## Use single particle generator
    import AthenaCommon.AtlasUnixGeneratorJob
    if hasattr(svcMgr, 'EventSelector'):
        svcMgr.EventSelector.FirstEvent = options['firstEvent']

    import ParticleGun as PG
    topSequence += PG.ParticleGun(randomStream = "SINGLE", randomSeed = simFlags.RandomSeedOffset.get_Value())
    topSequence.ParticleGun.sampler.pid = int(options["pid"])
    if options["configFileName"] != "" :
        energy={}
        inputfile=open(options["ConfigFileName"])
        for line in inputfile:
            for v in line.split():
                data.append(int(v))
        energyBins=set(data)
        topSequence.ParticleGun.sampler.mom = PG.EEtaMPhiSampler(energy=energyBins, eta=[3.8, 4.8])
    elif options["fcalrings"] is not None:
        topSequence.ParticleGun.sampler.mom = PG.EEtaMPhiSampler(energy=100,eta=100.)
        topSequence.ParticleGun.sampler.pos = PG.PosSampler(x=[70,90], y=[70,90],  z=options["fcalrings"])
        # z=4720 and 100k events should be enough to see something.
        # One can draw full Fcal using (x=[-500,500], y=[-500,500],  z=4720), but need >10M events.
    else:
        print (options["energyMin"], options["energyMax"])
        topSequence.ParticleGun.sampler.mom = PG.EEtaMPhiSampler(energy=set([100000,200000,500000]), eta=[-5.0,-3.0, 3.0,5.0])
    evgenConfig.generators += ["ParticleGun"]
    athenaCommonFlags.PoolEvgenInput.set_Off()

if (options['parameterize'] > 0):
    simFlags.LArParameterization=options['parameterize']

    if len(options['fsLibs']) > 0 :
        printfunc ("Setting up ShowerLib Service")
        from LArG4ShowerLibSvc.LArG4ShowerLibSvcConfig import getLArG4ShowerLibSvc
        if not hasattr( ServiceMgr, 'LArG4ShowerLibSvc' ):
             ServiceMgr += getLArG4ShowerLibSvc()
        ServiceMgr.LArG4ShowerLibSvc.FileNameList = options['fsLibs']


## Set Event #
simFlags.RunNumber = options['runNumber']

if options['simulate']:
    include("G4AtlasApps/G4Atlas.flat.configuration.py")

    from AthenaCommon.CfgGetter import getAlgorithm
    topSequence += getAlgorithm("G4AtlasAlg",tryDefaultConfigurable=True)
    topSequence.G4AtlasAlg.InputTruthCollection = "GEN_EVENT"
    from MagFieldServices import SetupField

else:
    if athenaCommonFlags.PoolEvgenInput.statusOn:
        ## Tell the event selector about the evgen input files and event skipping
        if not hasattr(svcMgr, 'EventSelector'):
            import AthenaPoolCnvSvc.ReadAthenaPool
        svcMgr.EventSelector.InputCollections = athenaCommonFlags.PoolEvgenInput()
        if athenaCommonFlags.SkipEvents.statusOn:
            svcMgr.EventSelector.SkipEvents = athenaCommonFlags.SkipEvents()

    ## GeoModel stuff
    from AtlasGeoModel import SetGeometryVersion
    from AtlasGeoModel import GeoModelInit
    from AtlasGeoModel import SimEnvelopes
    from MagFieldServices import SetupField

from LArG4Validation.LArG4ValidationConf import SingleTrackValidation
topSequence += SingleTrackValidation()

# The following lines are to construct our ntuple:
RootFileName = options['output'] + '.tuple.root'

NtupleSvc = Service( "NTupleSvc" )
NtupleSvc.Output = [ "FILE DATAFILE=\'" + RootFileName + "\' OPT='NEW'" ]

theApp.Dlls   +=  [  "RootHistCnv"   ]
theApp.HistogramPersistency = "ROOT"
